# ポケモンバトル支援システム 基本設計書


---

## 1. システム概要 (System Overview)

### 1.1 背景と目的

ポケモン対戦において、初心者は「タイプ相性」や「素早さ関係」の判断に時間がかかり、制限時間内に最適な行動を選択できないという課題がある。
本システムは、対戦相手のポケモンを選択するだけで、ユーザーの手持ちポケモンの中から**最適な（効果抜群かつ先制可能な）ポケモン**を瞬時に推奨し、対戦の意思決定を支援することを目的とする。

### 1.2 システムの機能

* **手持ち管理機能（CRUD）**
  ユーザーの手持ちポケモンの登録、参照、更新（メモ）、削除

* **カスタム登録機能**
  既存の図鑑に存在しないオリジナルポケモンを作成・登録

* **対戦解析機能**
  敵ポケモンに対し、タイプ相性倍率と素早さを基準に有利なポケモンをランキング表示

* **データ初期化機能（DR）**
  データベースを初期状態（マスタデータのみ）にリセット

---

## 2. システムアーキテクチャ (System Architecture)

本システムは、拡張性と保守性を考慮し、**Web 3層構造（Web 3-Tier Architecture）** を採用する。

| 層          | 技術スタック                           | 役割                              |
| ---------- | -------------------------------- | ------------------------------- |
| プレゼンテーション層 | HTML5, CSS (Bootstrap 5), Jinja2 | ユーザーインターフェースの表示、レスポンシブデザイン対応    |
| アプリケーション層  | Python 3.x, Flask, Gunicorn      | ルーティング、ビジネスロジック（相性計算・ソート）、ORM操作 |
| データ層       | PostgreSQL 16（Render Managed）    | データの永続化、リレーション管理                |

---

## 3. データベース設計 (Database Design)

データの重複を排除し、整合性を保つために **第3正規形（3NF）** まで正規化を行う。

### 3.1 ER図 (Entity-Relationship Diagram)

※ ここにER図を挿入

### 3.2 テーブル定義

#### 1. Types（タイプマスタ）

全17種類のタイプを管理する。

* **type_id** (PK)
* **type_name**

#### 2. PokemonMaster（ポケモン図鑑マスタ）

全ポケモンの基本ステータスを管理する。

* **pokemon_id** (PK)
* **pokemon_name**
* **type_id** (FK)
* **speed**
* **attack**
* **defense**

#### 3. TypeEffectiveness（タイプ相性マスタ）

タイプ間の攻撃倍率を管理する交差テーブル。

* **id** (PK)
* **attack_type_id** (FK)
* **defense_type_id** (FK)
* **effectiveness** (float)

#### 4. UserPokemon（ユーザー手持ちテーブル）

ユーザーが所有するポケモン個体を管理する。

* **user_pokemon_id** (PK)
* **pokemon_id** (FK)
* **memo** (text)

---

## 4. 機能要件 (Functional Requirements)

### 4.1 画面一覧

#### メイン画面（index.html）

* すべての機能（登録・一覧・解析）を1ページに集約したSPA風UI

#### 対戦解析エリア

* 敵ポケモン選択プルダウン
* 解析実行ボタン
* 結果表示リスト

  * 推奨ポケモン
  * 相性がいまひとつのポケモン

### 4.2 ロジック仕様（解析アルゴリズム）

1. 敵ポケモンの **type_id** を取得
2. ユーザーの手持ちポケモン（UserPokemon）を全件取得
3. 各手持ちポケモンの **攻撃側 type_id** と敵の **防御側 type_id** を基に、TypeEffectiveness テーブルを **外部結合（Outer Join）**
4. 相性データが存在しない場合は、倍率を **1.0（等倍）** とする
5. 以下の優先順位でソートして表示

   * 第1キー: 相性倍率（降順）
   * 第2キー: 素早さ種族値（降順）

---

## 5. 非機能要件 (Non-Functional Requirements)

### 5.1 可用性・信頼性 (Availability & Reliability)

* **インフラ**: PaaS（Render）を利用し、サーバー管理コストを削減しつつ安定稼働
* **RPO（目標復旧時点）**: 24時間
  PostgreSQL の日次自動バックアップに準拠
* **RTO（目標復旧時間）**: 1時間
  障害検知後、バックアップからのリストアまたは再デプロイで復旧

### 5.2 性能 (Performance)

* レスポンスタイム目標: 画面表示・解析実行ともに **200ms以内**
* インデックス最適化により、データ量増加時も検索性能を維持

### 5.3 セキュリティ (Security)

* **通信暗号化**: 常時 SSL/TLS（HTTPS）通信を強制
* **DB接続情報管理**: 環境変数（DATABASE_URL）を使用し、コードへの直書きを禁止
* **インジェクション対策**: ORM（SQLAlchemy）を使用し、SQLインジェクションを防止
